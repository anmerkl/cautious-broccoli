AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Accepts and transforms Facebook data
Resources: 
  FBTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
      - Protocol: lambda
        Endpoint: !GetAtt FBTransform.Arn
  FBIngest:
    Type: AWS::Serverless::Function
    Properties:
      Handler: fb_ingest.handler
      Runtime: python3.6
      Policies:
        Statement:
          - Effect: Allow
            Action: SNS:Publish
            Resource: !Ref FBTopic
      Events:
        FBApi:
          Type: Api
          Properties:
            Path: /PushEvent
            Method: POST
      Environment:
        Variables:
          SNS_TOPIC_ARN: !Ref FBTopic
  FBTransform:
    Type: AWS::Serverless::Function
    Properties:
      Handler: fb_transform.handler
      Runtime: python3.6
      Events:
        FBSNS:
          Type: SNS
          Properties:
            Topic: !Ref FBTopic
  FBTransformInvokePermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref FBTransform
      Principal: sns.amazonaws.com